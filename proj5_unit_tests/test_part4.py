import pytest
import numpy as np
import logging
import cv2
from pathlib import Path
from proj5_code.student_code import (
    compute_absolute_poses
)
from proj5_code.utils import load_image, get_matches

DATA_ROOT = Path(__file__).resolve().parent.parent / "data"


def test_compute_absolute_poses():
    
    
    poses_rel = [([[ 9.99985794e-01,  1.13908055e-03, -5.20708242e-03,
         6.60811225e-03],
       [-1.11881941e-03,  9.99991799e-01,  3.89233030e-03,
         8.15796191e-04],
       [ 5.21147339e-03, -3.88644922e-03,  9.99978868e-01,
        -9.99977833e-01],
       [ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
         1.00000000e+00]]), ([[ 0.99997297,  0.00153785, -0.00719011,  0.02889104],
       [-0.00147846,  0.99996482,  0.00825712, -0.00171443],
       [ 0.00720256, -0.00824626,  0.99994006, -0.9995811 ],
       [ 0.        ,  0.        ,  0.        ,  1.        ]]), ([[ 0.99994917, -0.00182772, -0.00991573,  0.00672733],
       [ 0.00183938,  0.99999763,  0.00116623, -0.00783365],
       [ 0.00991358, -0.00118441,  0.99995016, -0.99994669],
       [ 0.        ,  0.        ,  0.        ,  1.        ]])]
    
    poses_abs = compute_absolute_poses(poses_rel)
    
    poses_true = [([[1., 0., 0., 0.],
       [0., 1., 0., 0.],
       [0., 0., 1., 0.],
       [0., 0., 0., 1.]]), ([[ 0.99998579, -0.00111882,  0.00521147, -0.00139575],
       [ 0.00113908,  0.9999918 , -0.00388645, -0.00470968],
       [-0.00520708,  0.00389233,  0.99997887,  0.99998794],
       [ 0.        ,  0.        ,  0.        ,  1.        ]]), ([[ 0.99991957, -0.00255419,  0.01242284, -0.0178712 ],
       [ 0.00270483,  0.99992284, -0.01212421, -0.01519266],
       [-0.01239092,  0.01215684,  0.99984933,  1.99979725],
       [ 0.        ,  0.        ,  0.        ,  1.        ]]), ([[ 9.99750230e-01, -7.00467670e-04,  2.23380316e-02,
        -2.26549709e-03],
       [ 9.97328392e-04,  9.99911305e-01, -1.32811051e-02,
        -2.06468118e-02],
       [-2.23267474e-02,  1.33000663e-02,  9.99662255e-01,
         2.99966060e+00],
       [ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00,
         1.00000000e+00]])]
    
    assert np.allclose(poses_abs, poses_true,atol=1e-2)
    
    



